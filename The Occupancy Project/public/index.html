<!DOCTYPE html>
<html>
<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>

<body>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h4>Login</h4>
            <div class="row">
                <form class="col s12">
                    <div class="row">
                        <div class="input-field col s12">
                        <input id="email_login" type="email" class="validate">
                        <label for="email_login">Email</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                        <input id="password_login" type="password" class="validate">
                        <label for="password_login">Password</label>
                        </div>
                    </div>     
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" id="loginBtn" class="modal-action modal-close waves-effect waves-green btn-flat">Login</a>
            <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat">Cancel</a>
        </div>
    </div>
    
    
    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <h4>Registration</h4>
            
            <div class="row">
                <form class="col s12">
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="first_name" type="text" class="validate">
                            <label for="first_name">First Name</label>
                        </div>

                        <div class="input-field col s6">
                            <input id="last_name" type="text" class="validate">
                            <label for="last_name">Last Name</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                        <input id="email_reg" type="email" class="validate">
                        <label for="email_reg">Email</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                        <input id="password_reg" type="password" class="validate">
                        <label for="password_reg">Password</label>
                        </div>
                    </div>     
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" id="registerBtn" class="modal-action modal-close waves-effect waves-green btn-flat">Register</a>
            <a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat">Cancel</a>
        </div>
    </div>
    
    <div id="splash-page" style="display: none;">
        <!-- Login/Registration Trigger -->
        <a class="waves-effect waves-light btn modal-trigger" id="loginModalTrigger">Login</a>
        <a class="waves-effect waves-light btn modal-trigger" id="registrationModalTrigger">Registration</a>
    </div>
    
    <div id="main-page" style="display: none;">
        <h2>Main Page</h2>
        <a class="waves-effect waves-light btn modal-trigger" id="logOffTrigger">Logoff</a>
        <br />
        <select id="building-selection">
        
        </select>
    </div>
    
    <div id="admin-page" style="display: none;">
        <h2>Admin Page</h2>
    </div>
    
    
<!--
    <h3>MAC Address to Room Mapping</h3>
    <table>
        <thead>
            <tr>
                <th>MAC Address</th>
                <th>Room Mapping</th>
            </tr>
        </thead>        
        <tbody id="macAddressToRoomMappingRows">
        
        </tbody>
    </table>
    <h4>Add New</h4>
    <form id="macAddressToRoomMappingForm">
        <div class="input-field col s6">
            <input id="macAddress" type="text">
            <label for="macAddress">Mac Address</label>
        </div>
    </form>
-->
    
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
    <script src="https://www.parsecdn.com/js/parse-1.6.2.min.js"></script>
    
    <script>
        Parse.initialize("VdWSfZSMsdaB6hfDRMFb1Ct4PJSqJErnABpwTRHW", "8DfK7ADN5SyQn1b9caOOQAhuaZCn1gX7wKSj1uRz");
        
        /* =======================================
        ========== INITIALIZATION ================
        ======================================= */
        
        var currentUser = Parse.User.current();
        if (currentUser) {
            // see if regular user or admin (TODO: Implement 3 parse roles, "Site-Admin", "Institution-Admin", and then a user who exists without extra permissions, for certain levels, limit class write access
            $("#main-page").show();
            $("#admin-page").show();
        } else {
            // not logged in, show splash page
            $("#splash-page").show();
        }
        
        /* =======================================
        ========== EVENT LISTENERS ===============
        ======================================= */
        
        $("#loginModalTrigger").click(function() {
            $('#loginModal').openModal(); 
        });
        
        $("#logOffTrigger").click(function() {
            Parse.User.logOut();
            $("#main-page").hide();
            $("#admin-page").hide();
            $("#splash-page").show();
        });
        
        $("#registrationModalTrigger").click(function() {
            $('#registrationModal').openModal(); 
        });
        
        $("#registerBtn").click(function() {
            
            // TODO : Error checking for empty or invalid inputs
            // TODO : Add verifcation email step (so don't log them in right away, make them verify their email, then bring them to the site to log in again when clicking the link
            
            var user = new Parse.User();
            user.set("first_name", $("#first_name").val());
            user.set("last_name", $("#last_name").val());
            user.set("username", $("#email_reg").val());
            user.set("email", $("#email_reg").val());
            user.set("password", $("#password_reg").val());    
            
            // get email domain
            var emailParts = $("#email_reg").val().split("@");
            var institutionDomain = emailParts[1];
            
            // look up institution id with that email
            var InstitutionClass = Parse.Object.extend("Institution");
            var query = new Parse.Query(InstitutionClass);
            query.equalTo("InstitutionDomain", institutionDomain);
            query.first({
              success: function(object) {
                // Successfully found institution
                var institutionId =  object.get("InstitutionId");
                user.set("InstitutionId", institutionId);
                user.set("InstitutionDomain", institutionDomain);
                  
                // sign user up
                user.signUp(null, {
                  success: function(user) {
//                    // Hooray! Let them use the app now.
//                      $("#splash-page").hide();
//                      $("#main-page").show();
//                      $("#admin-page").show();
                      alert("Confirmation email sent, please follow the link sent to log in");
                  },
                  error: function(user, error) {
                    // Show the error message somewhere and let the user try again.
                    alert("Error: " + error.code + " " + error.message);
                  }
                });
              },
              error: function(error) {
                // failed becuase institution isn't listed yet I think
                alert("Error: " + error.code + " " + error.message);
              }
            });
        });
  
        $("#loginBtn").click(function() {
            Parse.User.logIn($("#email_reg").val(), $("#password_reg").val(), {
              success: function(user) {
                $("#splash-page").hide();
                $("#main-page").show();
                $("#admin-page").show();
              },
              error: function(user, error) {
                alert("Error: " + error.code + " " + error.message);
              }
            });
        });
    </script>
</body>
</html>